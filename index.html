<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PRECISION ONCOLOGY NEURAL CORE v4.2 — 2050</title>

  <style>
    :root {
      --cyan: #00ffea;
      --magenta: #ff00aa;
      --green: #00ff88;
      --bg: #0a0a0a;
      --panel: #111122;
    }

    body {
      font-family: 'Courier New', Courier, monospace;
      font-size: 16px;
      background: var(--bg);
      color: var(--cyan);
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      background-image: 
        linear-gradient(rgba(0,255,234,0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,234,0.04) 1px, transparent 1px);
      background-size: 60px 60px;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .particles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }
    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: var(--cyan);
      border-radius: 50%;
      opacity: 0.35;
      animation: drift 18s infinite linear;
    }
    @keyframes drift {
      0%   { transform: translate(0,0); }
      25%  { transform: translate(80px, -120px); }
      50%  { transform: translate(-60px, -80px); }
      75%  { transform: translate(50px, -140px); }
      100% { transform: translate(0,0); }
    }

    h1 {
      text-align: center;
      font-size: 2.2rem;
      color: var(--magenta);
      text-shadow: 0 0 20px var(--magenta), 0 0 40px var(--magenta);
      margin: 0.8rem 0 2rem;
      letter-spacing: 4px;
      animation: titlePulse 4s infinite;
    }
    @keyframes titlePulse {
      0%,100% { text-shadow: 0 0 20px var(--magenta); }
      50%     { text-shadow: 0 0 40px var(--magenta), 0 0 60px var(--magenta); }
    }

    form {
      background: var(--panel);
      padding: 2rem;
      border: 5px outset var(--cyan);
      max-width: 960px;
      margin: 0 auto 3rem;
      box-shadow: 0 0 50px rgba(0,255,234,0.45);
      border-radius: 12px;
    }

    label {
      display: block;
      margin: 1.2rem 0 0.5rem;
      font-weight: bold;
      color: var(--cyan);
      text-shadow: 0 0 6px var(--cyan);
    }

    input, select, textarea {
      width: 100%;
      padding: 0.9rem;
      font: inherit;
      background: #000814;
      color: var(--cyan);
      border: 3px inset var(--cyan);
      box-shadow: inset 0 0 12px rgba(0,255,234,0.35);
      border-radius: 6px;
    }
    textarea { min-height: 160px; }

    button {
      background: #000;
      color: var(--magenta);
      border: 5px outset var(--magenta);
      padding: 1.2rem 3.5rem;
      font-size: 1.3rem;
      cursor: pointer;
      margin: 2.5rem auto 1rem;
      display: block;
      text-shadow: 0 0 10px var(--magenta);
      box-shadow: 0 0 35px rgba(255,0,170,0.65);
      transition: all 0.25s;
    }
    button:hover {
      background: #220033;
      transform: scale(1.06);
    }
    button:active { border-style: inset; }

    #output {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(10,20,30,0.92);
      border: 6px double var(--cyan);
      padding: 2.5rem;
      display: none;
      box-shadow: 0 0 90px rgba(0,255,234,0.55);
      border-radius: 16px;
      animation: glitch 3.5s infinite;
    }
    @keyframes glitch {
      0%,100% { transform: translate(0); text-shadow: 4px 0 var(--magenta), -4px 0 var(--cyan); }
      20%     { transform: translate(3px,-3px); }
      40%     { transform: translate(-3px,3px); }
    }

    h2, h3 { 
      color: var(--magenta); 
      text-shadow: 0 0 14px var(--magenta);
      border-bottom: 3px solid var(--cyan);
      padding-bottom: 0.6rem;
      margin-bottom: 1.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.8rem 0;
      background: #000814;
      box-shadow: 0 0 25px rgba(0,255,234,0.35);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid var(--cyan);
      padding: 1rem;
      text-align: left;
    }
    th { background: rgba(0,255,234,0.18); color: var(--magenta); }

    .chart-container {
      width: 100%;
      max-width: 900px;
      margin: 3rem auto;
      padding: 1.5rem;
      background: #000;
      border: 4px solid var(--magenta);
      box-shadow: 0 0 45px rgba(255,0,170,0.6);
      border-radius: 12px;
    }

    .disclaimer {
      color: var(--green);
      background: #001100;
      padding: 1.5rem;
      border: 3px dashed var(--green);
      text-shadow: 0 0 8px var(--green);
      font-size: 1.05rem;
      border-radius: 10px;
      margin: 3rem 0;
    }

    #downloadBtn {
      background: #000;
      color: var(--green);
      border: 5px outset var(--green);
      padding: 1.2rem 3.5rem;
      font-size: 1.3rem;
      cursor: pointer;
      margin: 3rem auto;
      display: block;
      text-shadow: 0 0 12px var(--green);
      box-shadow: 0 0 40px rgba(0,255,136,0.7);
    }
    #downloadBtn:hover { background: #002200; transform: scale(1.06); }

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.96);
      backdrop-filter: blur(12px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #loadingOverlay.active { display: flex; }

    .spinner {
      width: 110px;
      height: 110px;
      border: 10px solid rgba(0,255,234,0.25);
      border-top: 10px solid var(--cyan);
      border-radius: 50%;
      animation: spin 1.1s linear infinite;
      box-shadow: 0 0 60px rgba(0,255,234,0.6);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      margin-top: 2.5rem;
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--cyan);
      text-shadow: 0 0 15px var(--cyan);
      animation: pulse 2.2s infinite;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="particles" id="particles"></div>

<h1>PRECISION ONCOLOGY NEURAL CORE v4.2<br>2050 ULTRA-QUANTUM PROTOCOL</h1>

<form id="inputForm">
  <label>PATIENT / CASE ID</label>
  <input type="text" id="patientId" placeholder="e.g. NEO-2050-IX-077">

  <label>AGE</label>
  <input type="number" id="age" min="18" max="150">

  <label>SEX / GENOTYPE</label>
  <select id="sex">
    <option value="">--</option>
    <option value="M">M</option>
    <option value="F">F</option>
    <option value="O">NON-BINARY / SYNTH</option>
  </select>

  <label>NEOPLASM CLASSIFICATION</label>
  <select id="cancerType">
    <option value="">-- SELECT ONCOTYPE --</option>
    <option value="NSCLC">Non-Small Cell Lung Cancer</option>
    <option value="Breast">Breast Cancer</option>
    <option value="Colorectal">Colorectal Cancer</option>
    <option value="Pancreatic">Pancreatic Cancer</option>
    <option value="Other">Other</option>
  </select>

  <label>MOLECULAR PAYLOAD (comma separated)</label>
  <textarea id="mutations" placeholder="EGFR L858R, TP53 R175H, KRAS G12D, MSI-H, TMB 22 mut/Mb, PD-L1 95%"></textarea>

  <label>PD-L1 EXPRESSION (%)</label>
  <input type="number" id="pdl1" min="0" max="100">

  <label>PRIOR TREATMENTS</label>
  <input type="text" id="priorTx" placeholder="Osimertinib, Pembrolizumab + Platinum">

  <button type="button" onclick="runAnalysis()">EXECUTE ULTRA-NEURAL MATCH</button>
</form>

<div id="output">
  <h2>NEURAL CORE OUTPUT — PROTOCOL 2050</h2>

  <div class="section">
    <h3>DECODED SUBJECT PROFILE</h3>
    <table>
      <tr><th>ID / AGE / TYPE</th><td id="summaryPatient"></td></tr>
      <tr><th>ONCOTYPE</th><td id="summaryCancer"></td></tr>
      <tr><th>GENOMIC SIGNATURE</th><td id="summaryMutations"></td></tr>
      <tr><th>PD-L1</th><td id="summaryPDL1"></td></tr>
      <tr><th>PRIOR PROTOCOLS</th><td id="summaryPrior"></td></tr>
    </table>
  </div>

  <div class="section">
    <h3>MUTATION INTENSITY MATRIX</h3>
    <div class="chart-container"><canvas id="barChart"></canvas></div>
  </div>

  <div class="section">
    <h3>BIOMARKER HOLO-RADAR</h3>
    <div class="chart-container"><canvas id="radarChart"></canvas></div>
  </div>

  <div class="section">
    <h3>BIOMARKER TRAJECTORY PREDICTION (6–24 months)</h3>
    <div class="chart-container"><canvas id="lineChart"></canvas></div>
  </div>

  <div class="section">
    <h3>THERAPY RESPONSE / RISK SCATTER</h3>
    <div class="chart-container"><canvas id="scatterChart"></canvas></div>
  </div>

  <div class="section">
    <h3>RECRUITING TRIAL NEXUS</h3>
    <table id="trialsTable">
      <thead>
        <tr>
          <th>NCT</th>
          <th>Title</th>
          <th>Phase</th>
          <th>Match</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>OPTIMIZED THERAPY VECTORS</h3>
    <table id="therapyTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Regimen</th>
          <th>Est. Response</th>
          <th>Evidence</th>
          <th>Risk Flags</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="disclaimer">
    RESEARCH / SIMULATION USE ONLY — NOT MEDICAL ADVICE<br>
    OUTPUT MAY CONTAIN HALLUCINATIONS — ALWAYS VALIDATE WITH TUMOR BOARD
  </div>

  <button id="downloadBtn" onclick="downloadPDF()">EXPORT QUANTUM REPORT (PDF)</button>
</div>

<div id="loadingOverlay">
  <div style="text-align:center">
    <div class="spinner"></div>
    <div class="loading-text">CHAINING 6 NEURAL AGENTS • PROCESSING GENOME...</div>
  </div>
</div>

<script>
const HF_TOKEN = "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";

// ─── Particles ───────────────────────────────────────────────
for (let i = 0; i < 60; i++) {
  const p = document.createElement("div");
  p.className = "particle";
  p.style.left = Math.random()*100 + "%";
  p.style.top  = Math.random()*100 + "%";
  p.style.animationDelay = Math.random()*18 + "s";
  document.getElementById("particles").appendChild(p);
}

// ─── Main Analysis Pipeline ──────────────────────────────────
async function runAnalysis() {
  const patientId = document.getElementById("patientId").value.trim() || "UNKNOWN";
  const age       = document.getElementById("age").value       || "??";
  const sex       = document.getElementById("sex").value       || "??";
  const cancer    = document.getElementById("cancerType").value || "UNSPECIFIED";
  const mutations = document.getElementById("mutations").value.trim();
  const pdl1      = document.getElementById("pdl1").value      || "N/A";
  const prior     = document.getElementById("priorTx").value.trim() || "None";

  if (!cancer || !mutations) {
    alert("Please select cancer type and enter molecular alterations");
    return;
  }

  document.getElementById("loadingOverlay").classList.add("active");

  try {
    // Fill visible summary
    document.getElementById("summaryPatient").textContent   = `${patientId} (${age}y, ${sex})`;
    document.getElementById("summaryCancer").textContent    = cancer.toUpperCase();
    document.getElementById("summaryMutations").textContent = mutations;
    document.getElementById("summaryPDL1").textContent      = pdl1 + "%";
    document.getElementById("summaryPrior").textContent     = prior;

    // ─── Agent 1 ─── Genomics Parser ───────────────────────────────
    const genomics = await callAgent(`
You are Genomics Parser Agent.
Parse: cancer=${cancer}, alterations=${mutations}, PD-L1=${pdl1}
Return clean JSON only:
{
  "genes": ["EGFR","TP53",...],
  "alteration_counts": [3,4,...],
  "tmb": number,
  "msi_status": "High"|"Stable"|"...",
  "hrd_score": number,
  "tumor_purity": number,
  "neoantigen_load": number
}
`);

    const genes   = genomics.genes   || ["EGFR","TP53","KRAS","PIK3CA","MSI","OTHER"];
    const counts  = genomics.alteration_counts || [3,4,2,1,5,2];
    drawBarChart(genes, counts);

    drawRadarChart(
      genomics.tmb            || 18,
      genomics.msi_status === "High" ? 85 : 20,
      Number(pdl1) || 70,
      genomics.hrd_score      || 55,
      genomics.tumor_purity   || 88,
      genomics.neoantigen_load|| 75
    );

    // ─── Agent 2 ─── Biomarker Trajectory Predictor ────────────────
    const trajectory = await callAgent(`
You are Future Biomarker Projection Agent.
Given current biomarkers: ${JSON.stringify(genomics)}
Predict values at months 6,12,18,24,30 (5 points)
Return JSON only:
{
  "months": [6,12,18,24,30],
  "tmb_pred": [number,...],
  "pdl1_pred": [number,...]
}
`);

    drawLineChart(
      trajectory.months     || [6,12,18,24,30],
      trajectory.tmb_pred   || [18,16,14,12,10],
      trajectory.pdl1_pred  || [95,88,80,72,65]
    );

    // ─── Agent 3+4 ─── Trial Fetch + Matching ──────────────────────
    const rawTrials = await fetchClinicalTrials(cancer, mutations);
    const matched   = await callAgent(`
You are Global Trial Matching Agent.
Input trials (JSON array): ${JSON.stringify(rawTrials.slice(0,8))}
Patient biomarkers: ${mutations}
Select & rank top 3–5 best matches.
Return JSON array only:
[{"nct":"NCTxxxx","title":"short title","phase":"I/II","match_reason":"EGFR + TMB high","status":"RECRUITING"}]
`);

    populateTrialsTable(matched);

    // ─── Agent 5 ─── Therapy Optimizer ─────────────────────────────
    const therapies = await callAgent(`
You are Precision Therapy Optimizer Agent.
Cancer: ${cancer}
Alterations: ${mutations}
Prior tx: ${prior}
PD-L1: ${pdl1}%
Genomics summary: ${JSON.stringify(genomics)}
Propose 3 realistic regimens (single/combo).
Return JSON array only:
[{"rank":1,"regimen":"Osimertinib + Chemo","response_prob":"92%","evidence_level":"Phase III / NCCN","toxicity_flags":"QT prolongation, diarrhea"} , ...]
`);

    populateTherapyTable(therapies);

    // ─── Agent 6 ─── Final Safety Validator (light touch-up) ───────
    // (optional – can be merged into previous agent in production)

    document.getElementById("output").style.display = "block";
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

  } catch (err) {
    console.error(err);
    alert("NEURAL CORE EXCEPTION:\n" + err.message);
  } finally {
    document.getElementById("loadingOverlay").classList.remove("active");
  }
}

// ─── Helper: single agent call ───────────────────────────────────
async function callAgent(prompt) {
  try {
    const res = await fetch("https://router.huggingface.co/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${HF_TOKEN}`
      },
      body: JSON.stringify({
        model: "google/gemma-3-27b-it:featherless-ai",
        messages: [{ role: "user", content: prompt.trim() }],
        max_tokens: 1800,
        temperature: 0.65
      })
    });

    if (!res.ok) throw new Error(`HF API ${res.status}`);

    const data = await res.json();
    let text = data.choices?.[0]?.message?.content || "";

    // Try to extract JSON block
    const match = text.match(/\{[\s\S]*?\}|\[[\s\S]*?\]/);
    return match ? JSON.parse(match[0]) : {};
  } catch (e) {
    console.warn("Agent call failed:", e);
    return {};
  }
}

// ─── Real ClinicalTrials.gov fetch ───────────────────────────────
async function fetchClinicalTrials(cancer, terms) {
  try {
    const q = new URLSearchParams({
      "query.cond": cancer,
      "query.term": terms,
      "filter.overallStatus": "RECRUITING",
      "fields": "NCTId,BriefTitle,Phase,OverallStatus",
      "format": "json",
      "pageSize": "10"
    });
    const res = await fetch("https://clinicaltrials.gov/api/v2/studies?" + q);
    if (!res.ok) return [];
    const data = await res.json();
    return (data.studies || []).map(s => ({
      nct:   s.protocolSection?.identificationModule?.nctId || "—",
      title: s.protocolSection?.identificationModule?.briefTitle || "—",
      phase: s.protocolSection?.designModule?.phases?.[0] || "—",
      status: s.protocolSection?.statusModule?.overallStatus || "—"
    }));
  } catch {
    return [];
  }
}

function populateTrialsTable(rows) {
  const tbody = document.querySelector("#trialsTable tbody");
  tbody.innerHTML = "";
  (rows || []).slice(0,5).forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.nct}</td>
      <td>${r.title}</td>
      <td>${r.phase}</td>
      <td>${r.match_reason||r.match||"—"}</td>
      <td style="color:var(--green)">${r.status}</td>
    `;
    tbody.appendChild(tr);
  });
}

function populateTherapyTable(rows) {
  const tbody = document.querySelector("#therapyTable tbody");
  tbody.innerHTML = "";
  (rows || []).forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.rank}</td>
      <td>${r.regimen}</td>
      <td style="color:var(--green)">${r.response_prob}</td>
      <td>${r.evidence_level}</td>
      <td style="color:#ff6666">${r.toxicity_flags||"—"}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ─── Charts ──────────────────────────────────────────────────────
function drawBarChart(labels, data) {
  new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Alteration Strength",
        data,
        backgroundColor: "rgba(255,0,170,0.75)",
        borderColor: var(--magenta),
        borderWidth: 2
      }]
    },
    options: {
      scales: { y: { beginAtZero: true, grid: { color: "rgba(0,255,234,0.15)" }, ticks: { color: var(--cyan) } } },
      plugins: { legend: { labels: { color: var(--cyan) } } }
    }
  });
}

function drawRadarChart(tmb, msi, pdl1, hrd, purity, neo) {
  new Chart(document.getElementById("radarChart"), {
    type: "radar",
    data: {
      labels: ["TMB","MSI","PD-L1","HRD","Purity","Neoantigen"],
      datasets: [{
        label: "Current Profile",
        data: [tmb, msi, pdl1, hrd, purity, neo],
        backgroundColor: "rgba(0,255,234,0.28)",
        borderColor: var(--cyan),
        pointBackgroundColor: var(--magenta)
      }]
    },
    options: {
      scales: { r: { grid: { color: "rgba(0,255,234,0.25)" }, ticks: { color: var(--cyan) } } },
      plugins: { legend: { labels: { color: var(--magenta) } } }
    }
  });
}

function drawLineChart(months, tmbVals, pdl1Vals) {
  new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
      labels: months.map(m => m+" mo"),
      datasets: [
        { label: "Projected TMB", data: tmbVals, borderColor: var(--cyan), tension: 0.35, fill: false },
        { label: "Projected PD-L1", data: pdl1Vals, borderColor: var(--magenta), tension: 0.35, fill: false }
      ]
    },
    options: {
      scales: { y: { beginAtZero: true, grid: { color: "rgba(0,255,234,0.15)" }, ticks: { color: var(--cyan) } } },
      plugins: { legend: { labels: { color: var(--cyan) } } }
    }
  });
}

// ─── PDF Export ──────────────────────────────────────────────────
function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  doc.setFont("courier");
  doc.setFontSize(14);
  doc.text("PRECISION ONCOLOGY NEURAL REPORT — 2050", 40, 50);

  doc.setFontSize(10);
  let y = 90;
  const text = document.getElementById("output").innerText
    .replace(/\n\s*\n/g, "\n")          // collapse empty lines
    .split("\n");

  text.forEach(line => {
    if (y > 750) {
      doc.addPage();
      y = 50;
    }
    doc.text(line, 40, y);
    y += 14;
  });

  doc.save(`oncology-report-${Date.now()}.pdf`);
}
</script>
</body>
</html>
