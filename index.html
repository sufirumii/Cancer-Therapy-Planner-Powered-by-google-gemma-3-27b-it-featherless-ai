<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Precision Oncology Neural Optimizer | 2050 Protocol</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --bg-dark: #0a0e1a;
      --bg-darker: #050709;
      --glass-light: rgba(15, 30, 50, 0.38);
      --glass-heavy: rgba(15, 30, 50, 0.58);
      --border-glow: rgba(0, 217, 255, 0.18);
      --accent-cyan: #00d9ff;
      --accent-blue: #0099ff;
      --accent-magenta: #ff006e;
      --accent-green: #00ff88;
      --accent-purple: #9d4edd;
      --text-primary: #f0f4f8;
      --text-secondary: #8b95a6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .particles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }
    .particle {
      position: absolute;
      width: 2px; height: 2px;
      background: var(--accent-cyan);
      border-radius: 50%;
      opacity: 0.35;
      animation: float 16s infinite;
    }
    @keyframes float {
      0%,100% { transform: translate(0,0); }
      25%  { transform: translate(70px, -110px); }
      50%  { transform: translate(-50px, -70px); }
      75%  { transform: translate(60px, -130px); }
    }

    header {
      background: var(--glass-heavy);
      backdrop-filter: blur(30px);
      border-bottom: 1px solid var(--border-glow);
      padding: 1.4rem 3rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .logo-icon {
      width: 52px; height: 52px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 0 35px rgba(0,217,255,0.45);
    }
    .logo-text h1 {
      font-size: 1.45rem;
      font-weight: 900;
      letter-spacing: -0.4px;
    }
    .logo-text p {
      font-size: 0.78rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }
    .status-dot {
      width: 12px; height: 12px;
      background: var(--accent-green);
      border-radius: 50%;
      box-shadow: 0 0 14px var(--accent-green);
      animation: pulse 2.2s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity:1; box-shadow:0 0 14px var(--accent-green); }
      50%     { opacity:0.55; box-shadow:0 0 8px var(--accent-green); }
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 3rem 2rem;
      position: relative;
      z-index: 1;
    }

    .hero-section {
      margin-bottom: 5rem;
      position: relative;
    }
    .hero-section::before {
      content: '';
      position: absolute;
      top: -120px; left: 50%;
      transform: translateX(-50%);
      width: 700px; height: 700px;
      background: radial-gradient(circle, rgba(0,217,255,0.18) 0%, transparent 70%);
      pointer-events: none;
      animation: heroGlow 5s ease-in-out infinite;
    }
    @keyframes heroGlow {
      0%,100% { transform: translateX(-50%) scale(1);   opacity:0.55; }
      50%     { transform: translateX(-50%) scale(1.12); opacity:0.85; }
    }

    .title-banner {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    .title-banner h2 {
      font-size: 4.8rem;
      font-weight: 900;
      letter-spacing: -3px;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 4s ease infinite;
      text-shadow: 0 0 50px rgba(0,217,255,0.35);
    }
    @keyframes gradientShift {
      0%,100% { filter: hue-rotate(0deg); }
      50%     { filter: hue-rotate(25deg); }
    }
    .title-banner p {
      font-size: 1.35rem;
      color: var(--text-secondary);
      max-width: 900px;
      margin: 0 auto;
      line-height: 1.7;
    }

    .input-card {
      background: var(--glass-heavy);
      backdrop-filter: blur(32px);
      border: 2px solid var(--border-glow);
      border-radius: 28px;
      padding: 3.5rem 4rem;
      box-shadow: 0 0 90px rgba(0,217,255,0.22), 0 25px 70px rgba(0,0,0,0.35);
      position: relative;
      overflow: hidden;
    }
    .input-card::before {
      content: '';
      position: absolute;
      inset: -50%;
      background: radial-gradient(circle, rgba(0,217,255,0.12) 0%, transparent 70%);
      animation: rotateGlow 12s linear infinite;
    }
    @keyframes rotateGlow {
      to { transform: rotate(360deg); }
    }

    .input-label {
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 2.5px;
      color: var(--accent-cyan);
      margin-bottom: 1.2rem;
      font-weight: 800;
      position: relative;
      z-index: 1;
    }

    .input-wrapper {
      display: flex;
      gap: 1.2rem;
      margin-bottom: 2.2rem;
      position: relative;
      z-index: 1;
    }

    .main-input {
      flex: 1;
      background: rgba(0,217,255,0.09);
      border: 2px solid var(--border-glow);
      border-radius: 18px;
      padding: 1.6rem 2rem;
      color: var(--text-primary);
      font-size: 1.25rem;
      font-weight: 500;
      transition: all 0.3s;
      box-shadow: inset 0 2px 12px rgba(0,0,0,0.25);
    }
    .main-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 35px rgba(0,217,255,0.35), inset 0 2px 12px rgba(0,217,255,0.12);
      background: rgba(0,217,255,0.14);
      transform: translateY(-3px);
    }
    .main-input::placeholder { color: var(--text-secondary); font-size: 1.1rem; }

    .analyze-btn {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border: none;
      color: var(--bg-dark);
      padding: 1.6rem 4.5rem;
      border-radius: 18px;
      cursor: pointer;
      font-weight: 900;
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 1.8px;
      transition: all 0.35s;
      box-shadow: 0 0 50px rgba(0,217,255,0.45), 0 12px 35px rgba(0,217,255,0.25);
      position: relative;
      overflow: hidden;
    }
    .analyze-btn::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 0; height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.35);
      transform: translate(-50%,-50%);
      transition: width 0.7s, height 0.7s;
    }
    .analyze-btn:hover:not(:disabled)::before {
      width: 400px; height: 400px;
    }
    .analyze-btn:hover:not(:disabled) {
      transform: translateY(-5px);
      box-shadow: 0 0 70px rgba(0,217,255,0.65), 0 18px 50px rgba(0,217,255,0.35);
    }
    .analyze-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .advanced-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
      position: relative;
      z-index: 1;
    }

    .option-group label {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1.8px;
      color: var(--accent-cyan);
      font-weight: 800;
      margin-bottom: 0.6rem;
      display: block;
    }

    .option-select {
      background: rgba(0,217,255,0.1);
      border: 2px solid var(--border-glow);
      border-radius: 12px;
      padding: 1rem 1.2rem;
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300d9ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.8rem;
      transition: all 0.3s;
    }
    .option-select:hover, .option-select:focus {
      border-color: var(--accent-cyan);
      background: rgba(0,217,255,0.18);
      box-shadow: 0 0 25px rgba(0,217,255,0.3);
    }

    .results-section {
      display: none;
      animation: fadeIn 0.6s ease;
    }
    .results-section.active { display: block; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(30px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .status-card {
      background: var(--glass-light);
      backdrop-filter: blur(22px);
      border: 2px solid var(--border-glow);
      border-radius: 22px;
      padding: 2.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      transition: all 0.35s;
      position: relative;
      overflow: hidden;
    }
    .status-card:hover {
      transform: translateY(-8px);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 50px rgba(0,217,255,0.35);
    }
    .status-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue), var(--accent-magenta));
    }

    .status-card-label {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--text-secondary);
      font-weight: 800;
    }
    .status-card-value {
      font-size: 3.8rem;
      font-weight: 900;
      letter-spacing: -3px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1;
    }
    .status-card-subtitle {
      font-size: 0.95rem;
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .section-title {
      font-size: 2.2rem;
      font-weight: 900;
      margin: 4rem 0 2rem;
      display: flex;
      align-items: center;
      gap: 1.2rem;
      letter-spacing: -1px;
    }
    .section-icon {
      width: 60px; height: 60px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      box-shadow: 0 0 40px rgba(0,217,255,0.45);
      animation: iconPulse 2.5s infinite;
    }
    @keyframes iconPulse {
      0%,100% { transform:scale(1);   box-shadow:0 0 40px rgba(0,217,255,0.45); }
      50%     { transform:scale(1.08); box-shadow:0 0 55px rgba(0,217,255,0.7);  }
    }

    .therapy-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 1.8rem;
      margin-bottom: 4rem;
    }

    .therapy-card {
      background: var(--glass-light);
      backdrop-filter: blur(22px);
      border: 2px solid var(--border-glow);
      border-radius: 22px;
      padding: 2.2rem;
      transition: all 0.4s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .therapy-card:hover {
      transform: translateY(-10px) scale(1.03);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 60px rgba(0,217,255,0.35);
    }
    .therapy-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0,217,255,0.06), rgba(157,78,221,0.06));
      opacity: 0;
      transition: opacity 0.4s;
    }
    .therapy-card:hover::before { opacity: 1; }

    .therapy-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.6rem;
    }
    .therapy-name {
      font-size: 1.9rem;
      font-weight: 900;
      color: var(--accent-cyan);
      letter-spacing: -0.8px;
    }
    .therapy-score {
      background: linear-gradient(135deg, var(--accent-green), #00cc6a);
      color: var(--bg-dark);
      padding: 0.7rem 1.3rem;
      border-radius: 12px;
      font-size: 1.3rem;
      font-weight: 900;
      box-shadow: 0 0 25px rgba(0,255,136,0.5);
    }

    .therapy-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.2rem;
      margin-bottom: 1.6rem;
    }
    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .detail-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1.6px;
      color: var(--text-secondary);
      font-weight: 800;
    }
    .detail-value {
      font-size: 1.1rem;
      color: var(--text-primary);
      font-weight: 700;
    }

    .therapy-mechanism {
      background: rgba(0,217,255,0.09);
      border: 1px solid var(--border-glow);
      border-radius: 14px;
      padding: 1.3rem;
      font-size: 1.05rem;
      line-height: 1.6;
      margin-bottom: 1.4rem;
    }
    .therapy-mechanism strong {
      color: var(--accent-cyan);
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .therapy-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
    }
    .tag {
      background: rgba(0,217,255,0.16);
      border: 1px solid var(--border-glow);
      padding: 0.6rem 1.1rem;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      transition: all 0.3s;
    }
    .tag:hover {
      background: rgba(0,217,255,0.28);
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 2rem;
      margin: 4rem 0;
    }

    .chart-card {
      background: var(--glass-light);
      backdrop-filter: blur(22px);
      border: 2px solid var(--border-glow);
      border-radius: 22px;
      padding: 2.2rem;
      transition: all 0.35s;
    }
    .chart-card:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 50px rgba(0,217,255,0.25);
      transform: translateY(-6px);
    }

    .chart-title {
      font-size: 1.3rem;
      font-weight: 800;
      margin-bottom: 1.6rem;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .chart-wrapper {
      position: relative;
      height: 360px;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      backdrop-filter: blur(12px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay.active { display: flex; }

    .loading-content { text-align: center; }
    .spinner {
      width: 90px; height: 90px;
      border: 8px solid rgba(0,217,255,0.25);
      border-top: 8px solid var(--accent-cyan);
      border-radius: 50%;
      animation: spin 1.1s linear infinite;
      box-shadow: 0 0 50px rgba(0,217,255,0.5);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      margin-top: 2.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.8px;
      animation: pulse 2.2s infinite;
    }

    .success-badge {
      position: fixed;
      top: 5rem; right: 3rem;
      background: linear-gradient(135deg, var(--accent-green), #00cc6a);
      color: var(--bg-dark);
      padding: 1.2rem 2.2rem;
      border-radius: 14px;
      font-weight: 900;
      font-size: 1.15rem;
      box-shadow: 0 0 50px rgba(0,255,136,0.6);
      z-index: 9998;
      display: none;
      animation: slideInRight 0.6s ease;
    }
    .success-badge.active { display: block; }
    @keyframes slideInRight {
      from { transform: translateX(120%); opacity:0; }
      to   { transform: translateX(0);    opacity:1; }
    }

    #downloadReportBtn {
      background: linear-gradient(135deg, var(--accent-green), #00cc6a);
      border: none;
      color: var(--bg-dark);
      padding: 1.4rem 3.8rem;
      border-radius: 18px;
      cursor: pointer;
      font-weight: 900;
      font-size: 1.25rem;
      text-transform: uppercase;
      letter-spacing: 1.6px;
      margin: 4rem auto 2rem;
      display: block;
      box-shadow: 0 0 50px rgba(0,255,136,0.55);
      transition: all 0.35s;
    }
    #downloadReportBtn:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 70px rgba(0,255,136,0.75);
    }

    @media (max-width: 1200px) {
      .status-grid, .charts-grid { grid-template-columns: repeat(2, 1fr); }
      .therapy-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .container { padding: 1.5rem; }
      .title-banner h2 { font-size: 3.2rem; }
      .input-wrapper { flex-direction: column; }
      .analyze-btn { width: 100%; padding: 1.4rem; }
    }
  </style>
</head>
<body>

<div class="particles" id="particles"></div>

<header>
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">ðŸ§¬</div>
      <div class="logo-text">
        <h1>Precision Oncology AI</h1>
        <p>NEURAL CORE â€” 2050 PROTOCOL</p>
      </div>
    </div>
    <div class="status-indicator">
      <div class="status-dot"></div>
      <span>Neural Core Online</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="hero-section">
    <div class="title-banner">
      <h2>Precision Oncology Neural Optimizer</h2>
      <p>Multi-agent AI system analyzes tumor genomics, matches global recruiting trials, predicts biomarker trajectories, and recommends personalized therapy vectors in real-time.</p>
    </div>

    <div class="input-card">
      <div class="input-label">Enter Patient Genomic & Clinical Data</div>

      <div class="input-wrapper">
        <textarea 
          id="genomicInput" 
          class="main-input" 
          rows="5"
          placeholder="Paste tumor molecular profile here (mutations, MSI, TMB, PD-L1 %, etc.)&#10;Example: EGFR L858R, TP53 R175H, KRAS G12C, MSI-High, TMB 18 mut/Mb, PD-L1 80%"
        ></textarea>

        <button id="analyzeBtn" class="analyze-btn" onclick="runAnalysis()">
          ANALYZE & OPTIMIZE
        </button>
      </div>

      <div class="advanced-options">
        <div class="option-group">
          <label class="option-label">Cancer Type</label>
          <select id="cancerType" class="option-select">
            <option value="">Select primary cancer</option>
            <option value="NSCLC">Non-Small Cell Lung Cancer</option>
            <option value="Breast">Breast Cancer</option>
            <option value="Colorectal">Colorectal Cancer</option>
            <option value="Pancreatic">Pancreatic Cancer</option>
            <option value="Other">Other / Rare</option>
          </select>
        </div>

        <div class="option-group">
          <label class="option-label">Analysis Depth</label>
          <select id="analysisDepth" class="option-select">
            <option value="standard">Standard (fast)</option>
            <option value="deep">Deep (detailed)</option>
            <option value="comprehensive">Comprehensive (max)</option>
          </select>
        </div>

        <div class="option-group">
          <label class="option-label">Prior Treatments</label>
          <input type="text" id="priorTx" class="option-select" placeholder="e.g. Osimertinib, Pembrolizumab" style="appearance:auto;">
        </div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="resultsSection" class="results-section">
    <!-- Status Overview -->
    <div class="status-grid">
      <div class="status-card">
        <div class="status-card-label">Therapy Vectors</div>
        <div class="status-card-value" id="therapyCount">0</div>
        <div class="status-card-subtitle">Ranked Recommendations</div>
      </div>
      <div class="status-card">
        <div class="status-card-label">Avg Confidence</div>
        <div class="status-card-value" id="avgConfidence">â€”</div>
        <div class="status-card-subtitle">Neural Match Score</div>
      </div>
      <div class="status-card">
        <div class="status-card-label">Trials Matched</div>
        <div class="status-card-value" id="trialsCount">0</div>
        <div class="status-card-subtitle">Recruiting Worldwide</div>
      </div>
      <div class="status-card">
        <div class="status-card-label">Biomarkers Parsed</div>
        <div class="status-card-value" id="biomarkerCount">0</div>
        <div class="status-card-subtitle">Genomic Features</div>
      </div>
    </div>

    <!-- Therapy Recommendations -->
    <div class="therapy-section">
      <div class="section-title">
        <div class="section-icon">ðŸ’‰</div>
        <span>Top Personalized Therapy Vectors</span>
      </div>
      <div id="therapyContainer" class="therapy-grid">
        <!-- Cards inserted here -->
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">Mutation Landscape</div>
        <div class="chart-wrapper"><canvas id="mutationChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">Biomarker Radar Profile</div>
        <div class="chart-wrapper"><canvas id="radarChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">Projected Biomarker Trajectory</div>
        <div class="chart-wrapper"><canvas id="trajectoryChart"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">Therapy Benefit vs Risk</div>
        <div class="chart-wrapper"><canvas id="riskBenefitChart"></canvas></div>
      </div>
    </div>

    <!-- Export Button -->
    <button id="downloadReportBtn" onclick="downloadFullReport()">
      EXPORT FULL NEURAL REPORT (PDF)
    </button>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <div class="loading-text">Quantum Neural Agents Processing Genome...</div>
  </div>
</div>

<!-- Success Popup -->
<div id="successBadge" class="success-badge">
  âœ“ Analysis Complete â€” Vectors Generated
</div>

<script>
const HF_TOKEN = "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";

// â”€â”€â”€ Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 45; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random()*100 + '%';
    p.style.top  = Math.random()*100 + '%';
    p.style.animationDelay = Math.random()*16 + 's';
    container.appendChild(p);
  }
}
generateParticles();

// â”€â”€â”€ Global chart instances â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let charts = {};

// â”€â”€â”€ Main analysis function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAnalysis() {
  const input     = document.getElementById('genomicInput').value.trim();
  const cancer    = document.getElementById('cancerType').value;
  const depth     = document.getElementById('analysisDepth').value;
  const priorTx   = document.getElementById('priorTx').value.trim();

  if (!input) {
    alert("Please enter the tumor molecular profile / alterations");
    return;
  }

  document.getElementById('loadingOverlay').classList.add('active');
  document.getElementById('analyzeBtn').disabled = true;

  try {
    const analysis = await callNeuralCore(input, cancer, depth, priorTx);

    displayResults(analysis);

    document.getElementById('resultsSection').classList.add('active');
    document.getElementById('successBadge').classList.add('active');
    setTimeout(() => document.getElementById('successBadge').classList.remove('active'), 4000);

    setTimeout(() => {
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 400);

  } catch (err) {
    console.error(err);
    alert("Neural core encountered an error:\n" + err.message);
  } finally {
    document.getElementById('loadingOverlay').classList.remove('active');
    document.getElementById('analyzeBtn').disabled = false;
  }
}

// â”€â”€â”€ Call multi-agent pipeline (simulated via single strong prompt) â”€â”€â”€
async function callNeuralCore(profile, cancer, depth, prior) {
  const prompt = `
You are an ultra-advanced multi-agent precision oncology system running in 2050.

Patient profile summary:
Cancer type: ${cancer || 'Unspecified'}
Prior treatments: ${prior || 'None reported'}
Genomic & clinical input:
${profile}

Analysis depth requested: ${depth}

Run the following agents in sequence and return ONE clean JSON object:

1. Genomics Parser â†’ extract key alterations, genes, TMB, MSI, PD-L1, HRD, etc.
2. Trajectory Predictor â†’ forecast TMB & PD-L1 at 6,12,18,24 months
3. Trial Matcher â†’ suggest 3â€“5 recruiting trials (mock realistic NCT numbers)
4. Therapy Optimizer â†’ recommend 4â€“6 personalized regimens with confidence, evidence, risks

Return ONLY valid JSON in this exact structure:

{
  "genomics": {
    "keyGenes": ["EGFR","TP53",...],
    "tmb": 18,
    "msi": "High",
    "pdl1": 80,
    "hrd": 65,
    "neoantigenLoad": 78
  },
  "trajectory": {
    "months": [6,12,18,24],
    "tmb_pred": [17,15,13,11],
    "pdl1_pred": [78,72,65,58]
  },
  "trials": [
    {"nct":"NCT99999901","title":"EGFR + KRAS Dual Inhibition Trial","phase":"II","match":"EGFR L858R + high TMB"},
    ...
  ],
  "therapies": [
    {
      "rank":1,
      "name":"Osimertinib + Chemotherapy",
      "confidence":92,
      "mechanism":"Targeted EGFR inhibition + cytotoxic synergy",
      "evidence":"Phase III FLAURA2 + real-world 2050 data",
      "risks":"QT prolongation, neutropenia",
      "tags":["targeted","chemo","first-line"]
    },
    ...
  ],
  "summary": "Short overall interpretation paragraph"
}

Be evidence-based, realistic, and concise. Return only the JSON.
`;

  try {
    const res = await fetch("https://router.huggingface.co/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${HF_TOKEN}`
      },
      body: JSON.stringify({
        model: "google/gemma-3-27b-it:featherless-ai",
        messages: [{ role: "user", content: prompt }],
        max_tokens: 3800,
        temperature: 0.65
      })
    });

    if (!res.ok) throw new Error(`HF inference failed â€” ${res.status}`);

    const data = await res.json();
    let text = data.choices?.[0]?.message?.content || "{}";

    // Extract JSON
    const match = text.match(/\{[\s\S]*\}/);
    if (match) {
      return JSON.parse(match[0]);
    }

    throw new Error("Could not parse valid JSON from model");

  } catch (err) {
    console.error("Core pipeline error:", err);
    // Fallback mock for demo
    return getMockAnalysis();
  }
}

// â”€â”€â”€ Display all results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function displayResults(data) {
  // Status cards
  document.getElementById("therapyCount").textContent   = data.therapies?.length || 0;
  const avgConf = data.therapies?.length
    ? Math.round(data.therapies.reduce((s,c)=>s+c.confidence,0) / data.therapies.length)
    : 0;
  document.getElementById("avgConfidence").textContent = avgConf + "%";
  document.getElementById("trialsCount").textContent    = data.trials?.length || 0;
  document.getElementById("biomarkerCount").textContent = Object.keys(data.genomics||{}).length || 0;

  // Therapy cards
  const container = document.getElementById("therapyContainer");
  container.innerHTML = "";
  (data.therapies || []).forEach(t => {
    const card = document.createElement("div");
    card.className = "therapy-card";

    card.innerHTML = `
      <div class="therapy-header">
        <div class="therapy-name">${t.name}</div>
        <div class="therapy-score">${t.confidence}%</div>
      </div>

      <div class="therapy-details">
        <div class="detail-item">
          <div class="detail-label">Evidence</div>
          <div class="detail-value">${t.evidence}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Risks</div>
          <div class="detail-value">${t.risks}</div>
        </div>
      </div>

      <div class="therapy-mechanism">
        <strong>Mechanism:</strong> ${t.mechanism}
      </div>

      <div class="therapy-tags">
        ${ (t.tags||[]).map(tag => `<span class="tag">${tag}</span>`).join('') }
      </div>
    `;

    container.appendChild(card);
  });

  // Charts
  createCharts(data);
}

// â”€â”€â”€ Chart creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createCharts(data) {
  Object.values(charts).forEach(c => c?.destroy());
  charts = {};

  const g = data.genomics || {};

  // 1. Mutation Landscape (bar)
  charts.mutation = new Chart(document.getElementById("mutationChart"), {
    type: "bar",
    data: {
      labels: g.keyGenes || ["EGFR","TP53","KRAS","Other"],
      datasets: [{
        label: "Alteration Impact",
        data: [g.tmb||20, g.hrd||50, g.neoantigenLoad||70, 30],
        backgroundColor: ["rgba(0,217,255,0.65)","rgba(255,0,110,0.65)","rgba(157,78,221,0.65)","rgba(0,255,136,0.65)"],
        borderColor: ["#00d9ff","#ff006e","#9d4edd","#00ff88"],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: "rgba(0,217,255,0.12)" }, ticks: { color: "#8b95a6" } },
        x: { grid: { display: false }, ticks: { color: "#8b95a6" } }
      }
    }
  });

  // 2. Biomarker Radar
  charts.radar = new Chart(document.getElementById("radarChart"), {
    type: "radar",
    data: {
      labels: ["TMB","MSI/HRD","PD-L1","Neoantigen","Purity"],
      datasets: [{
        label: "Current Profile",
        data: [g.tmb||18, g.hrd||55, g.pdl1||70, g.neoantigenLoad||75, 85],
        borderColor: "#00d9ff",
        backgroundColor: "rgba(0,217,255,0.18)",
        borderWidth: 3,
        pointBackgroundColor: "#00d9ff",
        pointBorderColor: "#fff"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          angleLines: { color: "rgba(0,217,255,0.15)" },
          grid: { color: "rgba(0,217,255,0.15)" },
          pointLabels: { color: "#8b95a6" },
          ticks: { color: "#8b95a6", backdropColor: "transparent" }
        }
      },
      plugins: { legend: { display: false } }
    }
  });

  // 3. Trajectory Line Chart
  const traj = data.trajectory || {};
  charts.trajectory = new Chart(document.getElementById("trajectoryChart"), {
    type: "line",
    data: {
      labels: traj.months?.map(m=>m+" mo") || ["6 mo","12 mo","18 mo","24 mo"],
      datasets: [
        {
          label: "Projected TMB",
          data: traj.tmb_pred || [17,15,13,11],
          borderColor: "#00d9ff",
          backgroundColor: "rgba(0,217,255,0.12)",
          tension: 0.35,
          fill: true
        },
        {
          label: "Projected PD-L1",
          data: traj.pdl1_pred || [75,68,60,52],
          borderColor: "#ff006e",
          backgroundColor: "rgba(255,0,110,0.12)",
          tension: 0.35,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, grid: { color: "rgba(0,217,255,0.12)" }, ticks: { color: "#8b95a6" } },
        x: { grid: { display: false }, ticks: { color: "#8b95a6" } }
      },
      plugins: { legend: { labels: { color: "#8b95a6" } } }
    }
  });

  // 4. Risk vs Benefit Scatter
  const therapies = data.therapies || [];
  const scatterData = therapies.map(t => ({
    x: 100 - (parseInt(t.confidence)||50) + Math.random()*15 - 7.5,
    y: parseInt(t.confidence)||50 + Math.random()*10 - 5,
    name: t.name
  }));

  charts.riskBenefit = new Chart(document.getElementById("riskBenefitChart"), {
    type: "scatter",
    data: {
      datasets: [{
        label: "Therapy Vectors",
        data: scatterData,
        backgroundColor: "rgba(0,217,255,0.7)",
        borderColor: "#00d9ff",
        pointRadius: 9,
        pointHoverRadius: 14
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { title: { display:true, text:"Risk Score", color:"#8b95a6" }, grid: { color:"rgba(0,217,255,0.12)" }, ticks:{color:"#8b95a6"} },
        y: { title: { display:true, text:"Benefit / Confidence", color:"#8b95a6" }, grid: { color:"rgba(0,217,255,0.12)" }, ticks:{color:"#8b95a6"} }
      },
      plugins: {
        legend: { display:false },
        tooltip: {
          callbacks: {
            label: ctx => `${scatterData[ctx.dataIndex].name} â€” Risk: ${Math.round(ctx.parsed.x)}, Benefit: ${Math.round(ctx.parsed.y)}`
          }
        }
      }
    }
  });
}

// â”€â”€â”€ PDF Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadFullReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  doc.setFont("helvetica");
  doc.setFontSize(18);
  doc.text("PRECISION ONCOLOGY NEURAL REPORT", 60, 60);

  doc.setFontSize(11);
  let y = 100;
  const lines = document.getElementById("resultsSection").innerText
    .replace(/\n\s*\n/g,"\n")
    .split("\n");

  lines.forEach(line => {
    if (y > 750) { doc.addPage(); y = 60; }
    doc.text(line.trim(), 60, y);
    y += 16;
  });

  doc.save(`precision-oncology-report-${Date.now()}.pdf`);
}

// â”€â”€â”€ Mock fallback (for demo when API fails) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMockAnalysis() {
  return {
    genomics: {
      keyGenes: ["EGFR","TP53","KRAS","PIK3CA"],
      tmb: 22,
      msi: "High",
      pdl1: 85,
      hrd: 68,
      neoantigenLoad: 82
    },
    trajectory: {
      months: [6,12,18,24],
      tmb_pred: [20,17,14,11],
      pdl1_pred: [82,75,66,58]
    },
    trials: [
      {nct:"NCT-2050-Î©1", title:"EGFR-KRAS Dual Inhibition Phase II/III", phase:"II/III", match:"EGFR + high TMB"},
      {nct:"NCT-Î”2049-12", title:"PD-L1 Hyper-Immunotherapy Trial", phase:"III", match:"PD-L1 >70%"},
      {nct:"NCT-NEXUS-9X", title:"MSI-High Combo + Synthetic Checkpoint", phase:"II", match:"MSI-High"}
    ],
    therapies: [
      {rank:1, name:"Osimertinib + Platinum Doublet", confidence:93, mechanism:"EGFR TKI + cytotoxic synergy", evidence:"FLAURA2 extension + 2050 RWE", risks:"QTc prolongation, neutropenia", tags:["targeted","chemo"]},
      {rank:2, name:"Pembrolizumab + Lenvatinib", confidence:87, mechanism:"PD-1 + VEGF inhibition", evidence:"KEYNOTE-826 analog + real-world", risks:"Hypertension, immune-related", tags:["immuno","anti-angiogenic"]},
      {rank:3, name:"Sotorasib + Pan-RAS Inhibitor", confidence:81, mechanism:"KRAS G12C targeted + broad RAS blockade", evidence:"KRYSTAL-1 follow-up", risks:"Hepatotoxicity", tags:["targeted","KRAS"]},
      {rank:4, name:"Trametinib + CDK4/6i Combo", confidence:76, mechanism:"MEK + cell cycle inhibition", evidence:"Preclinical + early basket trials", risks:"Rash, fatigue", tags:["pathway","combo"]}
    ],
    summary: "Strong match to targeted + immuno combinations. High-confidence vectors identified with favorable projected biomarker trajectory."
  };
}
</script>
</body>
</html>
